<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wrenchly – Auto-onderhoud</title>
  <style>
    /* ---------- Design tokens ---------- */
    :root{
      --bg:#f6f7f8; --text:#1d1f21; --card:#ffffff; --border:#e5e7eb;
      --header:#eef2f7; --hover:#f3f6fb;
      --tab-inactive:#f0f1f4; --tab-inactive-text:#222;
      --brand:#18FF83; --brand-text:#042f1b;
      --muted:#6b7280; --danger:#ef4444;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#121214; --text:#f5f5f7; --card:#191a1f; --border:#2a2a30;
        --header:#202127; --hover:#26272d;
        /* lighter gray for inactive tabs so they’re visible */
        --tab-inactive:#2f3138; --tab-inactive-text:#f3f4f6;
        --brand:#18FF83; --brand-text:#00180d;
        --muted:#9ca3af; --danger:#f87171;
      }
    }

    /* ---------- Base ---------- */
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg); color:var(--text); margin:1.5rem;
    }
    h1{margin:0 0 1rem; font-weight:800; font-size:clamp(1.6rem, 1.1rem + 2vw, 3.2rem);}

    /* ---------- Layout header ---------- */
    .toprow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:.75rem;
      align-items:center;
    }
    .tabs{display:flex; gap:.5rem; flex-wrap:wrap;}
    .actions{display:flex; gap:.5rem; justify-self:end;}

    /* ---------- Tabs & buttons ---------- */
    .tab{
      border:1px solid var(--border);
      background:var(--tab-inactive);
      color:var(--tab-inactive-text);
      padding:.55rem 1rem; border-radius:12px; cursor:pointer;
      font-weight:700; transition:filter .2s ease, background .2s ease;
    }
    .tab:hover{filter:brightness(1.06)}
    .tab.active{background:var(--brand); color:var(--brand-text); border-color:transparent;}

    .btn{
      border:1px solid var(--border); background:var(--card);
      color:var(--text); padding:.55rem 1rem; border-radius:12px; cursor:pointer;
      font-weight:700; transition:filter .2s ease;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn.primary{background:var(--brand); color:var(--brand-text); border-color:transparent;}

    /* ---------- Search ---------- */
    .toolbar{display:flex; gap:.6rem; align-items:center; margin:.9rem 0;}
    .toolbar label{font-weight:700}
    .toolbar input{
      flex:1 1 360px; min-width:200px;
      border:1px solid var(--border); background:var(--card); color:var(--text);
      padding:.55rem .8rem; border-radius:10px;
    }

    /* ---------- Tables ---------- */
    table{width:100%; border-collapse:collapse; border-radius:14px; overflow:hidden;}
    th, td{padding:.7rem .9rem; border-bottom:1px solid var(--border); vertical-align:top;}
    th{background:var(--header); text-align:left;}
    tr:hover{background:var(--hover)}
    .right{text-align:right}
    .detail{display:none; background:var(--hover)}
    .totals{text-align:right; padding:.6rem .2rem; font-weight:700;}
    .muted{color:var(--muted); font-size:.95rem}

    /* ---------- Inline error ---------- */
    .error{
      margin:.75rem 0; padding:.6rem .8rem; border-left:4px solid var(--danger);
      background:var(--card); border-radius:10px; color:var(--text);
    }

    /* ---------- Responsive ---------- */
    @media (max-width:720px){
      .toprow{grid-template-columns: 1fr; gap:.5rem}
      .actions{justify-self:start}
      th, td{padding:.6rem .7rem}
    }
  </style>
</head>
<body>
  <h1>Auto-onderhoud overzicht</h1>

  <!-- Tabs left, actions right -->
  <div class="toprow">
    <div class="tabs">
      <button class="tab active" data-tab="reparaties">Reparaties</button>
      <button class="tab" data-tab="service">Serviceboekje</button>
      <button class="tab" data-tab="upcoming">Aanstaand onderhoud</button>
    </div>
    <div class="actions">
      <button id="csvBtn" class="btn">Exporteer CSV</button>
      <button id="planTopBtn" class="btn primary">Plan afspraak</button>
    </div>
  </div>

  <!-- Search (only for reparaties) -->
  <div class="toolbar" id="searchWrap">
    <label for="q">Zoeken:</label>
    <input id="q" type="text" placeholder="Bijv. airco, remmen, banden…"/>
  </div>
  <div id="inlineError" class="error" style="display:none"></div>

  <!-- Reparaties -->
  <section id="reparatiesSection">
    <table id="repTable">
      <thead>
        <tr><th>Datum</th><th>Garage</th><th class="right">Totaalbedrag</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="repTotals" class="totals"></div>
  </section>

  <!-- Serviceboekje -->
  <section id="serviceSection" style="display:none">
    <table id="serviceTable">
      <thead>
        <tr>
          <th>Datum</th><th>Garage</th><th>Type</th>
          <th>Soort onderhoud</th><th>Kilometerstand</th><th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Aanstaand onderhoud -->
  <section id="upcomingSection" style="display:none">
    <table id="upTable">
      <thead>
        <tr><th>Verwachte datum</th><th>Onderdeel</th><th>Omschrijving</th><th class="right">Geschatte kosten</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    /* ---------- Helpers ---------- */
    const formatEuro = (n) => new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' }).format(Number(n || 0));
    const fmtDate = (iso)=>{
      if(!iso) return '–';
      const d=new Date(iso);
      return isNaN(d)? iso : d.toLocaleDateString('nl-NL'); // dd-mm-jjjj
    };
    const fmtKM = (km)=> (km==null || km==='') ? '–' : new Intl.NumberFormat('nl-NL').format(km)+' km';
    const showErr = (msg)=>{
      const el = document.getElementById('inlineError');
      el.textContent = msg;
      el.style.display = '';
    };

    /* ---------- Tabs ---------- */
    const tabs = document.querySelectorAll('.tab');
    const sections = {
      reparaties: document.getElementById('reparatiesSection'),
      service: document.getElementById('serviceSection'),
      upcoming: document.getElementById('upcomingSection'),
    };
    const searchWrap = document.getElementById('searchWrap');

    tabs.forEach(tab=>{
      tab.addEventListener('click', ()=>{
        tabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const sel = tab.dataset.tab;
        Object.entries(sections).forEach(([key, el])=>{
          el.style.display = (key===sel) ? '' : 'none';
        });
        searchWrap.style.display = (sel==='reparaties') ? '' : 'none';
      });
    });

    /* ---------- Data load (robust) ---------- */
    let DATA = { bonnen:[], service:[], upcoming_maintenance:[] };

    // Resolve data.json reliably (handles subpaths)
    const dataUrl = (new URL('./data.json', window.location.href)).toString();

    fetch(dataUrl + '?nocache=' + Date.now())
      .then(r=>{
        if(!r.ok) throw new Error('HTTP '+r.status+' bij laden data.json');
        return r.text(); // read as text first to surface JSON errors
      })
      .then(txt=>{
        try{
          const d = JSON.parse(txt);
          DATA.bonnen = Array.isArray(d.bonnen) ? d.bonnen : [];
          DATA.service = Array.isArray(d.service) ? d.service : [];
          DATA.upcoming_maintenance = Array.isArray(d.upcoming_maintenance) ? d.upcoming_maintenance : [];
          if(!DATA.bonnen.length && !DATA.service.length && !DATA.upcoming_maintenance.length){
            console.warn('Lege data.json of onjuiste sleutels.', d);
            showErr('Let op: geen gegevens gevonden in data.json. Controleer de sleutels "bonnen", "service" en "upcoming_maintenance".');
          }
          renderRep(); renderService(); renderUpcoming();
        }catch(e){
          console.error('JSON parse fout:', e);
          showErr('Kon data.json niet lezen (ongeldige JSON).');
        }
      })
      .catch(err=>{
        console.error('Laden data.json mislukt:', err);
        showErr('Kon data.json niet laden. Staat het bestand in de root van je project?');
      });

    /* ---------- Reparaties ---------- */
    const repBody = document.querySelector('#repTable tbody');
    const repTotals = document.getElementById('repTotals');
    const searchInput = document.getElementById('q');

    function renderRep(){
      repBody.innerHTML = '';
      const q = (searchInput.value||'').toLowerCase();
      let total = 0;

      DATA.bonnen
        .filter(b => !q || (b.omschrijving||'').toLowerCase().includes(q))
        .forEach(b=>{
          total += Number(b.totaal||0);

          const row = document.createElement('tr');
          row.style.cursor='pointer';
          row.innerHTML = `
            <td>${fmtDate(b.factuurdatum)}</td>
            <td>${b.garage||'–'}</td>
            <td class="right">${formatEuro(b.totaal)}</td>
          `;

          const det = document.createElement('tr');
          det.className='detail';
          det.innerHTML = `
            <td colspan="3">
              <strong>Factuurnummer:</strong> ${b.factuurnummer||'–'}<br>
              <strong>Kilometerstand:</strong> ${fmtKM(b.kilometerstand)}<br>
              <strong>Omschrijving:</strong> ${b.omschrijving||'–'}<br>
              <strong>Categorie:</strong> ${b.categorie||'–'}
            </td>
          `;

          repBody.append(row, det);
          row.addEventListener('click', ()=> {
            det.style.display = det.style.display==='table-row' ? 'none' : 'table-row';
          });
        });

      repTotals.textContent = 'Totaal uitgegeven aan reparaties: ' + €(total);
    }
    searchInput.addEventListener('input', renderRep);

    /* ---------- CSV export ---------- */
    document.getElementById('csvBtn').addEventListener('click', ()=>{
      const rows = [['Factuurnummer','Datum','Garage','Omschrijving','Kilometerstand','Totaal']];
      DATA.bonnen.forEach(b=>{
        rows.push([
          b.factuurnummer||'',
          fmtDate(b.factuurdatum),
          (b.garage||'').replaceAll(';',','),
          (b.omschrijving||'').replaceAll(';',','),
          b.kilometerstand||'',
          String(Number(b.totaal||0)).replace('.',',')
        ]);
      });
      const csv = rows.map(r=>r.join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `wrenchly_reparaties_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    });

    /* ---------- Serviceboekje ---------- */
    const serviceBody = document.querySelector('#serviceTable tbody');
    function renderService(){
      serviceBody.innerHTML='';
      const today = new Date();
      DATA.service.forEach(b=>{
        const hist = new Date(b.datum) < today;
        const status = hist ? '✅ Uitgevoerd' : '⏳ Binnenkort';
        serviceBody.innerHTML += `
          <tr>
            <td>${fmtDate(b.datum)}</td>
            <td>${b.garage||'–'}</td>
            <td>${b.type_beurt||'–'}</td>
            <td>${b.soort_onderhoud||'–'}</td>
            <td>${fmtKM(b.kilometerstand)}</td>
            <td>${status}</td>
          </tr>`;
      });
    }

    /* ---------- Aanstaand onderhoud ---------- */
    const upBody = document.querySelector('#upTable tbody');
    function renderUpcoming(){
      upBody.innerHTML='';
      DATA.upcoming_maintenance.forEach(u=>{
        upBody.innerHTML += `
          <tr>
            <td>${fmtDate(u.verwachte_datum)}</td>
            <td>${u.onderdeel||'–'}</td>
            <td>${u.omschrijving||'–'}</td>
            <td class="right">${€(u.geschatte_kosten)}</td>
          </tr>`;
      });
    }
  </script>
</body>
</html>
