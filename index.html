<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wrenchly ‚Äì Auto-onderhoud</title>
  <style>
    :root{
      --bg:#f6f7f8;--text:#1d1f21;--card:#ffffff;--border:#e5e7eb;
      --header:#eef2f7;--hover:#f3f6fb;--brand:#18FF83;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#121214;--text:#f5f5f7;--card:#1c1c20;--border:#2a2a30;
        --header:#242429;--hover:#26262d;
      }
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica Neue,Arial,sans-serif;
      background:var(--bg);color:var(--text);margin:1.5rem;}
    h1{margin-bottom:1rem;font-weight:800;}
    .tab{border:1px solid var(--border);background:var(--card);
      padding:.5rem 1rem;border-radius:10px;cursor:pointer;}
    .tab.active{background:var(--brand);color:#002;}
    .btn{border:1px solid var(--border);background:var(--card);padding:.5rem .9rem;
      border-radius:10px;cursor:pointer;}
    .btn.primary{background:var(--brand);border:none;font-weight:600;}
    .search-box{margin:.7rem 0;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:.6rem .8rem;border-bottom:1px solid var(--border);}
    th{background:var(--header);text-align:left;}
    tr:hover{background:var(--hover);}
    .right{text-align:right;}
    .detail{display:none;background:var(--hover);}
    .totals{text-align:right;padding:.6rem;font-weight:700;}
    .toast{position:fixed;right:20px;bottom:20px;background:var(--card);
      border-left:5px solid var(--brand);padding:12px 16px;border-radius:12px;
      opacity:0;transform:translateY(20px);transition:all .3s ease;z-index:100;}
    .toast.show{opacity:1;transform:translateY(0);}
  </style>
</head>
<body>
  <h1>Auto-onderhoud overzicht</h1>

  <div>
    <button class="tab active" data-tab="reparaties">Reparaties</button>
    <button class="tab" data-tab="service">Serviceboekje</button>
    <button class="tab" data-tab="upcoming">Aanstaand onderhoud</button>
    <button id="planTopBtn" class="btn primary" style="margin-left:10px;">Plan afspraak</button>
  </div>

  <div class="search-box" id="searchWrap">
    <label for="q">Zoeken:</label>
    <input id="q" type="text" placeholder="Bijv. airco, remmen, banden‚Ä¶" />
    <button id="csvBtn" class="btn">Exporteer CSV</button>
  </div>

  <section id="reparatiesSection">
    <table id="repTable">
      <thead><tr><th>Datum</th><th>Garage</th><th class="right">Totaalbedrag</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="repTotals" class="totals"></div>
  </section>

  <section id="serviceSection" style="display:none">
    <table id="serviceTable">
      <thead><tr><th>Datum</th><th>Garage</th><th>Type</th><th>Soort onderhoud</th><th>Kilometerstand</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="upcomingSection" style="display:none">
    <table id="upTable">
      <thead><tr><th>Verwachte datum</th><th>Onderdeel</th><th>Omschrijving</th><th class="right">Geschatte kosten</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <div id="toast" class="toast"></div>

  <script>
    const ‚Ç¨ = n=> new Intl.NumberFormat('nl-NL',{style:'currency',currency:'EUR'}).format(n??0);
    const fmtDate = iso=>{const d=new Date(iso);if(isNaN(d))return iso;return d.toLocaleDateString('nl-NL');};
    const fmtKM = km=> km?new Intl.NumberFormat('nl-NL').format(km)+' km':'‚Äì';
    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

    const tabs=document.querySelectorAll('.tab');
    const sections={reparaties:document.getElementById('reparatiesSection'),service:document.getElementById('serviceSection'),upcoming:document.getElementById('upcomingSection')};
    tabs.forEach(t=>t.addEventListener('click',()=>{tabs.forEach(b=>b.classList.remove('active'));t.classList.add('active');Object.keys(sections).forEach(k=>sections[k].style.display=k===t.dataset.tab?'':'none');}));

    let DATA={bonnen:[],service:[],upcoming_maintenance:[]};
    fetch('data.json?nocache='+Date.now())
      .then(r=>r.json())
      .then(d=>{DATA=d;renderRep();renderService();renderUpcoming();})
      .catch(e=>console.error('Fout bij laden JSON:', e));

    /* Reparaties */
    const repBody=document.querySelector('#repTable tbody');
    const repTotals=document.getElementById('repTotals');
    function renderRep(){
      repBody.innerHTML='';let total=0;const q=document.getElementById('q').value.toLowerCase();
      (DATA.bonnen||[]).filter(b=>!q||(b.omschrijving||'').toLowerCase().includes(q)).forEach(f=>{
        total+=f.totaal||0;
        const row=document.createElement('tr');row.innerHTML=`<td>${fmtDate(f.factuurdatum)}</td><td>${f.garage}</td><td class="right">${‚Ç¨(f.totaal)}</td>`;
        const det=document.createElement('tr');det.className='detail';
        det.innerHTML=`<td colspan="3"><strong>Factuurnummer:</strong> ${f.factuurnummer}<br><strong>Kilometerstand:</strong> ${fmtKM(f.kilometerstand)}<br><strong>Omschrijving:</strong> ${f.omschrijving}<br><strong>Categorie:</strong> ${f.categorie}</td>`;
        repBody.append(row,det);
        row.addEventListener('click',()=>det.style.display=det.style.display==='table-row'?'none':'table-row');
      });
      repTotals.textContent='Totaal uitgegeven aan reparaties: '+‚Ç¨(total);
    }
    document.getElementById('q').addEventListener('input',renderRep);

    /* CSV export */
    document.getElementById('csvBtn').onclick=()=>{
      const rows=[['Factuurnummer','Datum','Garage','Omschrijving','Kilometerstand','Totaal']];
      (DATA.bonnen||[]).forEach(b=>rows.push([b.factuurnummer,fmtDate(b.factuurdatum),b.garage,b.omschrijving,b.kilometerstand,‚Ç¨(b.totaal)]));
      const csv=rows.map(r=>r.join(';')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`wrenchly_reparaties_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      showToast('üì¶ CSV-bestand ge√´xporteerd.');
    };

    /* Service */
    const serviceBody=document.querySelector('#serviceTable tbody');
    function renderService(){
      serviceBody.innerHTML='';
      const today=new Date();
      (DATA.service||[]).forEach(b=>{
        const hist=new Date(b.datum)<today;
        serviceBody.innerHTML+=`<tr><td>${fmtDate(b.datum)}</td><td>${b.garage}</td><td>${b.type_beurt}</td><td>${b.soort_onderhoud}</td><td>${fmtKM(b.kilometerstand)}</td><td>${hist?'‚úÖ Uitgevoerd':'‚è≥ Binnenkort'}</td></tr>`;
      });
    }

    /* Aanstaand onderhoud */
    const upBody=document.querySelector('#upTable tbody');
    function renderUpcoming(){
      upBody.innerHTML='';
      (DATA.upcoming_maintenance||[]).forEach(u=>{
        upBody.innerHTML+=`<tr><td>${fmtDate(u.verwachte_datum)}</td><td>${u.onderdeel}</td><td>${u.omschrijving}</td><td class="right">${‚Ç¨(u.geschatte_kosten)}</td></tr>`;
      });
    }
  </script>
</body>
</html>
